name: Build VKD3D-Proton for Android/Winlator (aarch64)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-slatest

    steps:
    - name: Checkout VKD3D-Proton
      uses: actions/checkout@v4
      with:
        repository: 'HansKristian-Work/vkd3d-proton'
        ref: master
        submodules: recursive
        fetch-depth: 0

    - name: Debug checkout
      run: |
        pwd
        ls -la .
        echo "--- Buscando meson.build ---"
        find . -name "meson.build" -type f | head -5 || echo "No se encontró meson.build"
        echo "--- Contenido de root ---"
        ls -la | grep -E "(meson\.build|README|include|src|subprojects)"

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y meson ninja-build pkg-config git clang cmake ccache
        sudo apt install -y libvulkan-dev spirv-tools glslang-dev
        sudo apt install -y mingw-w64 mingw-w64-tools  # <-- añade mingw-w64-tools para widl

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r26b

    - name: Create Meson cross-file for Android aarch64
      run: |
        export NDK=${{ steps.setup-ndk.outputs.ndk-path }}
        CLANG="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang"
        CLANGPP="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++"
        LLD="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/ld.lld"
        LLVM_AR="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
        LLVM_STRIP="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"
        PKG_CONFIG="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/pkg-config"
        SYSROOT="$NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
        cat > cross-android.meson << EOF
        [binaries]
        ar = '$LLVM_AR'
        c = ['ccache', '$CLANG']
        cpp = ['ccache', '$CLANGPP', '-fno-exceptions', '-fno-unwind-tables', '-fno-asynchronous-unwind-tables', '--start-no-unused-arguments', '-static-libstdc++', '--end-no-unused-arguments']
        c_ld = '$LLD'
        cpp_ld = '$LLD'
        strip = '$LLVM_STRIP'
        pkg-config = '$PKG_CONFIG'

        [host_machine]
        system = 'android'
        cpu_family = 'aarch64'
        cpu = 'armv8'
        endian = 'little'

        [built-in options]
        c_args = ['-target', 'aarch64-linux-android34', '-D__ANDROID_API__=34', '-march=armv8.2-a+fp16+rcpc', '-mfpu=neon-fp-armv8', '-mfloat-abi=hard']
        cpp_args = ['-target', 'aarch64-linux-android34', '-D__ANDROID_API__=34', '-march=armv8.2-a+fp16+rcpc', '-mfpu=neon-fp-armv8', '-mfloat-abi=hard']

        [properties]
        sys_root = '$SYSROOT'
        bindgen_clang_arguments = ['-target', 'aarch64-linux-android34', '--sysroot', '$SYSROOT']
        EOF
        ls -la cross-android.meson
        cat cross-android.meson

    - name: Setup Meson build
      env:
        CC: clang
        CXX: clang++
        PKG_CONFIG_SYSROOT_DIR: "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
        PKG_CONFIG_LIBDIR: "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android"
        PKG_CONFIG_PATH: "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/pkgconfig"
      run: |
        export NDK=${{ steps.setup-ndk.outputs.ndk-path }}
        meson setup build \
        --cross-file cross-android.meson \
        -Ddebug=false \
        -Doptimization=s \
        -Dstrip=true \
        -Denable_tests=false
        if [ -d build ]; then ninja -C build -t targets | head -20; else echo "Build dir no creado"; fi

    - name: Compile
      run: |
        export NDK=${{ steps.setup-ndk.outputs.ndk-path }}
        meson compile -C build -j $(nproc)

    - name: Install and package as WCP
      run: |
        export NDK=${{ steps.setup-ndk.outputs.ndk-path }}
        meson install -C build --destdir dist
        cd dist
        tar -cf ../vkd3d-proton-android-arm64ec.wcp usr/* --use-compress-program=zstd -c --ultra -22
        cd ..

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: vkd3d-proton-android-arm64ec
        path: |
          build/*.so
          vkd3d-proton-android-arm64ec.wcp
          dist/
        retention-days: 30