name: Build VKD3D-Proton for Android/Winlator (aarch64)

on:
  push:
    branches: [ master ]  # Cambia a 'develop' si usas una fork con esa rama
  workflow_dispatch:  # Permite ejecución manual

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout VKD3D-Proton
      uses: actions/checkout@v4
      with:
        repository: 'HansKristian-Work/vkd3d-proton'  # Repo upstream con meson.build
        ref: master  # Rama master (o 'develop' si existe)
        submodules: recursive  # Para SPIRV-Cross, GLSLang y otros submódulos
        fetch-depth: 0  # Clon full para submodules

    - name: Debug checkout  # Mantenido para verificar (quita después si todo OK)
      run: |
        pwd
        ls -la .
        echo "--- Buscando meson.build ---"
        find . -name "meson.build" -type f | head -5 || echo "No se encontró meson.build"
        echo "--- Contenido de root ---"
        ls -la | grep -E "(meson\.build|README|include|src|subprojects)"

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y meson ninja-build pkg-config git clang cmake ccache
        sudo apt install -y libvulkan-dev spirv-tools glslang-dev  # Headers para Vulkan y shaders (host)

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r26b  # Versión reciente con LLVM/Clang para API 34+

    - name: Create Meson cross-file for Android aarch64 (Winlator/FEX-compatible)
      run: |
        export NDK=${{ steps.setup-ndk.outputs.ndk-path }}
        cat > cross-android.meson << EOF
        [constants]
        ndk_path = '$NDK'

        [binaries]
        ar = '$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
        c = ['ccache', '$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang']
        cpp = ['ccache', '$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++', '-fno-exceptions', '-fno-unwind-tables', '-fno-asynchronous-unwind-tables', '--start-no-unused-arguments', '-static-libstdc++', '--end-no-unused-arguments']
        c_ld = '$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang'
        cpp_ld = '$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++'
        strip = '$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'
        pkg-config = '$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/pkg-config'

        [host_machine]
        system = 'android'
        cpu_family = 'aarch64'
        cpu = 'armv8'
        endian = 'little'

        [built-in options]
        c_args = ['-target', 'aarch64-linux-android34', '-D__ANDROID_API__=34', '-march=armv8.2-a+fp16+rcpc', '-mfpu=neon-fp-armv8', '-mfloat-abi=hard']
        cpp_args = ['-target', 'aarch64-linux-android34', '-D__ANDROID_API__=34', '-march=armv8.2-a+fp16+rcpc', '-mfpu=neon-fp-armv8', '-mfloat-abi=hard']

        [properties]
        sys_root = '$NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot'
        bindgen_clang_arguments = ['-target', 'aarch64-linux-android34', '--sysroot', '$NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot']
        EOF
        # Debug: Verifica cross-file
        ls -la cross-android.meson
        cat cross-android.meson

    - name: Setup Meson build
      env:
        CC: clang
        CXX: clang++
        PKG_CONFIG_SYSROOT_DIR: "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
        PKG_CONFIG_LIBDIR: "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android"
        PKG_CONFIG_PATH: "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/pkgconfig"
      run: |
        export NDK=${{ steps.setup-ndk.outputs.ndk-path }}
        # Comando en una sola línea
        meson setup . build --cross-file cross-android.meson -Ddebug=false -Doptimization=s -Dstrip=true
        # Verifica configuración (targets disponibles)
        if [ -d build ]; then ninja -C build -t targets | head -20; else echo "Build dir no creado"; fi

    - name: Compile
      run: |
        export NDK=${{ steps.setup-ndk.outputs.ndk-path }}
        meson compile -C build -j $(nproc)

    - name: Install and package as WCP
      run: |
        export NDK=${{ steps.setup-ndk.outputs.ndk-path }}
        meson install -C build --destdir dist
        # Empaqueta como .tar.zst para Winlator WCP (incluye .so y headers)
        cd dist
        tar -cf ../vkd3d-proton-android-arm64ec.wcp usr/* --use-compress-program=zstd -c --ultra -22
        cd ..

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: vkd3d-proton-android-arm64ec
        path: |
          build/*.so  # Librerías como libvkd3d-proton.so
          vkd3d-proton-android-arm64ec.wcp
          dist/
        retention-days: 30
